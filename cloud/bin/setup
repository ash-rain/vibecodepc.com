#!/usr/bin/env bash
set -euo pipefail

# VibeCodePC Cloud Edge — Local Development Setup
# Usage: bin/setup

cd "$(dirname "$0")/.."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${BOLD}==> $1${NC}"; }
ok()    { echo -e "${GREEN}    ✓ $1${NC}"; }
warn()  { echo -e "${YELLOW}    ! $1${NC}"; }
fail()  { echo -e "${RED}    ✗ $1${NC}"; exit 1; }

# --- Prerequisites -----------------------------------------------------------

info "Checking prerequisites..."

command -v php >/dev/null 2>&1 || fail "PHP is not installed"
PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;')
PHP_MAJOR=$(echo "$PHP_VERSION" | cut -d. -f1)
PHP_MINOR=$(echo "$PHP_VERSION" | cut -d. -f2)
if [ "$PHP_MAJOR" -lt 8 ] || { [ "$PHP_MAJOR" -eq 8 ] && [ "$PHP_MINOR" -lt 2 ]; }; then
    fail "PHP 8.2+ required (found $PHP_VERSION)"
fi
ok "PHP $PHP_VERSION"

command -v composer >/dev/null 2>&1 || fail "Composer is not installed"
ok "Composer $(composer --version 2>/dev/null | sed -n 's/.*Composer version \([0-9.]*\).*/\1/p')"

command -v node >/dev/null 2>&1 || fail "Node.js is not installed"
ok "Node $(node --version)"

command -v npm >/dev/null 2>&1 || fail "npm is not installed"
ok "npm $(npm --version)"

# --- Composer -----------------------------------------------------------------

info "Installing PHP dependencies..."
composer install --no-interaction --prefer-dist --quiet
ok "Composer packages installed"

# --- Environment --------------------------------------------------------------

info "Setting up environment..."
if [ ! -f .env ]; then
    cp .env.example .env
    # Default to SQLite for local dev (no MySQL/Redis needed)
    sed -i.bak 's/^DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env
    sed -i.bak 's/^SESSION_DRIVER=redis/SESSION_DRIVER=database/' .env
    sed -i.bak 's/^QUEUE_CONNECTION=redis/QUEUE_CONNECTION=sync/' .env
    sed -i.bak 's/^CACHE_STORE=redis/CACHE_STORE=database/' .env
    rm -f .env.bak
    ok "Created .env from .env.example (configured for SQLite)"
else
    warn ".env already exists, skipping"
fi

if grep -q "^APP_KEY=$" .env 2>/dev/null; then
    php artisan key:generate --quiet
    ok "Application key generated"
else
    warn "APP_KEY already set, skipping"
fi

# --- Database -----------------------------------------------------------------

info "Setting up database..."
DB_CONNECTION=$(grep "^DB_CONNECTION=" .env | cut -d= -f2)
if [ "$DB_CONNECTION" = "sqlite" ]; then
    if [ ! -f database/database.sqlite ]; then
        touch database/database.sqlite
        ok "Created SQLite database"
    else
        warn "SQLite database already exists"
    fi
else
    ok "Using $DB_CONNECTION (ensure the database exists)"
fi

php artisan migrate --force --quiet
ok "Migrations complete"

# --- Seed ---------------------------------------------------------------------

info "Seeding test data..."
if php artisan db:seed --force --quiet 2>/dev/null; then
    ok "Database seeded (admin user + test devices)"
else
    warn "Seeding skipped (data may already exist)"
fi

# --- Frontend -----------------------------------------------------------------

info "Installing frontend dependencies..."
npm install --silent 2>/dev/null
ok "npm packages installed"

npm run build --silent 2>/dev/null
ok "Assets built"

# --- Filament -----------------------------------------------------------------

info "Setting up Filament admin panel..."
php artisan filament:upgrade --quiet 2>/dev/null || true
ok "Filament assets published"

# --- Done ---------------------------------------------------------------------

echo ""
echo -e "${GREEN}${BOLD}Setup complete!${NC}"
echo ""
echo "  Start the dev server:   php artisan serve"
echo "  Start with HMR:         composer run dev"
echo "  Run tests:              php artisan test"
echo "  Admin panel:            http://localhost:8000/admin"
echo "                          Login: admin@vibecodepc.com / password"
echo ""
