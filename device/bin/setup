#!/usr/bin/env bash
set -euo pipefail

# VibeCodePC Device Setup
# Installs and configures all services needed for the device to run.
# Production (RPi): sudo bin/setup
# Development (macOS): sudo bin/setup

DEVICE_USER="${VIBECODEPC_USER:-vibecodepc}"
CODESERVER_PORT="${VIBECODEPC_CODESERVER_PORT:-8443}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
APP_DIR="$(dirname "$SCRIPT_DIR")"
IS_LINUX=false
[[ "$(uname)" == "Linux" ]] && IS_LINUX=true
IS_DOCKER_BUILD=false
[[ "${VIBECODEPC_DOCKER_BUILD:-0}" == "1" ]] && IS_DOCKER_BUILD=true

# ---------- helpers ----------

info()  { echo -e "\033[1;34m[info]\033[0m  $*"; }
ok()    { echo -e "\033[1;32m[ok]\033[0m    $*"; }
warn()  { echo -e "\033[1;33m[warn]\033[0m  $*"; }
fail()  { echo -e "\033[1;31m[error]\033[0m $*"; exit 1; }

need_root() {
    if [[ $EUID -ne 0 ]]; then
        fail "This script must be run as root (sudo bin/setup)"
    fi
}

command_exists() { command -v "$1" &>/dev/null; }

run_as_user() { sudo -u "$DEVICE_USER" "$@"; }

# ---------- system user ----------

setup_user() {
    info "Setting up ${DEVICE_USER} user..."

    if $IS_LINUX; then
        if id "$DEVICE_USER" &>/dev/null; then
            ok "User ${DEVICE_USER} already exists"
            return
        fi

        groupadd --system "$DEVICE_USER"
        useradd --system --gid "$DEVICE_USER" --create-home --shell /bin/bash "$DEVICE_USER"

        ok "Created user and group: ${DEVICE_USER}"
    else
        DEVICE_USER="$(logname 2>/dev/null || echo "${SUDO_USER:-$USER}")"
        ok "macOS dev mode — using current user: ${DEVICE_USER}"
    fi
}

# ---------- avahi / mDNS ----------

install_avahi() {
    if ! $IS_LINUX; then
        warn "Skipping Avahi setup on macOS (Bonjour handles mDNS)"
        return
    fi

    if $IS_DOCKER_BUILD; then
        warn "Skipping Avahi setup in Docker build"
        return
    fi

    info "Installing Avahi for mDNS discovery..."

    apt-get install -y -qq avahi-daemon avahi-utils libnss-mdns > /dev/null

    # Set hostname to vibecodepc so device is reachable at vibecodepc.local
    hostnamectl set-hostname vibecodepc

    systemctl enable avahi-daemon
    systemctl start avahi-daemon

    ok "Avahi installed — device discoverable as vibecodepc.local"
}

# ---------- code-server ----------

install_code_server() {
    info "Installing code-server..."

    if command_exists code-server; then
        ok "code-server already installed: $(code-server --version | head -1)"
    else
        curl -fsSL https://code-server.dev/install.sh | sh
        ok "code-server installed: $(code-server --version | head -1)"
    fi
}

configure_code_server() {
    info "Configuring code-server..."

    # Write config to the default code-server location for the user that runs PHP.
    # On RPi this is the vibecodepc user; in Docker it's www-data.
    local php_user="${DEVICE_USER}"
    if $IS_DOCKER_BUILD; then
        php_user="www-data"
    fi

    local user_home
    user_home="$(eval echo "~${php_user}")"
    local config_dir="${user_home}/.config/code-server"
    local config_file="${config_dir}/config.yaml"

    mkdir -p "$config_dir"

    cat > "$config_file" <<EOF
bind-addr: 127.0.0.1:${CODESERVER_PORT}
auth: none
cert: false
EOF

    chown -R "${php_user}" "$config_dir"

    ok "code-server config written to ${config_file}"
}

setup_code_server_service() {
    if $IS_DOCKER_BUILD; then
        warn "Skipping systemd service setup in Docker build"
        return
    fi

    if ! $IS_LINUX; then
        warn "Skipping systemd service setup on macOS"
        return
    fi

    info "Setting up code-server systemd service..."

    cat > /etc/systemd/system/code-server@.service <<EOF
[Unit]
Description=code-server for %i
After=network.target

[Service]
Type=exec
User=%i
ExecStart=/usr/bin/code-server --bind-addr 127.0.0.1:${CODESERVER_PORT}
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable "code-server@${DEVICE_USER}"
    systemctl start "code-server@${DEVICE_USER}"

    ok "code-server service enabled and started"
}

# ---------- laravel app ----------

setup_laravel_app() {
    info "Setting up Laravel application..."

    cd "$APP_DIR"

    # PHP dependencies
    if [[ -f composer.json ]]; then
        run_as_user composer install --no-dev --optimize-autoloader --no-interaction
    fi

    # Environment
    if [[ ! -f .env ]]; then
        cp .env.example .env
        run_as_user php artisan key:generate --no-interaction
    fi

    # Database
    local db_file="database/database.sqlite"
    if [[ ! -f "$db_file" ]]; then
        run_as_user touch "$db_file"
    fi
    run_as_user php artisan migrate --force --no-interaction

    # Device identity
    run_as_user php artisan device:generate-id --no-interaction

    # Frontend assets
    if $IS_DOCKER_BUILD; then
        warn "Skipping npm build in Docker (volumes override)"
    elif [[ -f package.json ]]; then
        run_as_user npm ci --no-audit
        run_as_user npm run build
    fi

    ok "Laravel app configured"
}

# ---------- main ----------

main() {
    echo ""
    echo "  VibeCodePC Device Setup"
    echo "  ======================"
    echo ""

    need_root

    setup_user

    install_avahi

    install_code_server
    configure_code_server
    setup_code_server_service

    if $IS_DOCKER_BUILD; then
        warn "Skipping Laravel app setup in Docker build (handled at container start)"
    else
        setup_laravel_app
        # Ensure the device user owns the app directory
        chown -R "${DEVICE_USER}" "$APP_DIR"
    fi

    echo ""
    ok "Device setup complete!"
    echo ""
    info "Next steps:"
    echo "  1. Scan the QR code on your device to pair it"
    echo "  2. The wizard will walk you through AI services, VS Code, and tunnel setup"
    echo ""
}

main "$@"
